# MOD 11
## Anomaly Detection
### NetFlow Search Query Basics
<img width="1999" height="1394" alt="150ccb94-fa9c-4c90-a77f-6fc344e98d94" src="https://github.com/user-attachments/assets/eac69f8a-ca97-4f17-93b3-a9a2ba49f229" />

#### Understanding NefFlow Data in SecOnion
- Network devices (such as routers or switches) using protocols like **NetFlow v5**, **NetFlow v9**, or Internet Protocol Flow Information Export (**IPFIX**), send data to a collector.
- For Security Onion, that collector is **Filebeat** (specifically collected through Filebeat’s NetFlow module). 

#### NetFlow Data Ingestion
- The Filebeat NetFlow module listens on a configured port ([UDP] or [TCP]) for incoming raw NetFlow data from these devices.
- When NetFlow records arrive, the Filebeat NetFlow module **normalizes and enriches** them into one of the nine data types described above, saving the data into **netflow.log**.
- It then forwards the normalized records to Elasticsearch for long-term storage and analysis.

#### Log Generation and Processing
- Filebeat processes the incoming NetFlow data using a pipeline.
- For this lesson’s version of Security Onion, the pipeline is **filebeat-7.17-1-netflow-log-pipeline**. 
- The ingested NetFlow data is broken into hundreds of fields, depending on the NetFlow version and the values present in the data.
- Each field has an associated data type.
- For example, netflow.destination_ipv4_address is an ip type, and netflow.destination_transport_port is an integer type.

- The pipeline performs field extraction, parsing, and normalization to create structured records with predefined fields.
- Common fields that may be used to perform NetFlow queries include, but are not limited to, the following:
  - event.action: netflow_flow
  - event.dataset: netflow.log
  - event.module: netflow
  - flow.id: (random assigned id)
  - input.type: netflow
  - service.type: netflow
  - netflow.destination_ipv4_address
  - netflow.destination_transport_port

### NetFlow Search Queries
- View entire count of NetFlow data: `* | groupby event.dataset`
- Show Source IP with highest occurance: `* | groupby event.dataset netflow.source_ipv4_address`
- Add an additinal column for desination IP" `* | groupby event.dataset netflow.source_ipv4_address netflow.destination_ipv4_address`
- View source port numbers: `* | groupby event.dataset netflow.source_transport_port`
- Create a column of destination ports: `* | groupby event.dataset netflow.source_transport_port netflow.destination_transport_port`

#### NetFlow Queries Using Kibana
- Query for NetFlow data: `event.dataset: "netflow.log"`
  - Add the following fields to the output: `source.ip`, `destination.ip`, `source.port`, `destination.port`
- Refine search to identify IP addresses using port 0: `event.dataset: "netflow.log" and (netflow.source_transport_port: 0 and netflow.destination_transport_port: 0)`
- Search for flows larger than .095MB or larger than 100,000 bytes: `event.dataset: "netflow.log" and network.bytes > 100000`


## Identifying DDos Attack
### Denial of Service Identification
- The goal of a DoS attack is to prevent legitimate users from accessing a service or resource.
- This loss of access can range from a single service or machine to an entire network or multiple networks.
- There are many different categories of DoS attacks, each with their own characteristics and varying degrees of impact.
- A (DDoS) attack is a DoS attack that is launched from more than one attacker-controlled host.
- Hosts used in a DDoS attack might be from a large number of attackers coordinating their attack or from unwitting bots under the control of a single attacker.

- NetFlow data is useful in determining both the presence and magnitude of a DoS attack.
- Although an infinite number of possibilities exists, depending on the network and attack, several common attacks and indicators within NetFlow can be observed.
- Examples of attacks and indicators include high bandwidth/slow performance, Synchronize (**SYN**) floods, amplification Domain Name System (**DNS**) floods, and amplification reflection Synchronize-Acknowledge (**SYN-ACK**) floods. 

#### High Bandwidth and Slow Performance
- Slow performance is an almost-universal sign of a DoS attack.
- Because the goal of a DoS attack is to deny service, causing resources to become disruptively slow is an acceptable outcome from an attacker’s perspective.
- DDoS attacks use multiple systems to overwhelm a target, so higher-than-normal levels of traffic are observed within NetFlow data.
- Depending on the type of attack, these elevated traffic levels may be seen as spikes at precise times or as continuous floods.  

#### SYN Floods 
- The well-known “three-way handshake” used when establishing a (TCP) connection is a frequent target of abuse in a DoS attack.
- Normally, a client sends a SYN message to a server, which then causes the server to reply with a SYN-ACK message.
- Upon receipt of the SYN-ACK message, the client sends an ACK message back to the server. 
<img width="1999" height="476" alt="b2dc2861-072d-4a0a-b64a-9bca7b5018e0" src="https://github.com/user-attachments/assets/2e377feb-3015-4c1c-96e7-f144732ae229" />

- A SYN flood takes advantage of the server’s willingness to send SYN-ACK responses to incoming SYN messages.
- An attacker rapidly sends large quantities of SYN packets to open ports on the target’s server.
- The unwitting server then begins to send SYN-ACK replies to the attacker.
  - However, the attacker’s Internet Protocol (IP) address is often spoofed or fake.
- This means that the SYN-ACK reply never reaches its intended client, and the victim server waits for the acknowledgement of the SYN-ACK with an open connection.
- Although the server can close the port by sending a Reset (RST) packet, another malicious SYN packet arrives before the server can do so, starting the cycle again.
- This state, in which the server awaits ACK packets and cannot close the ports with a RST packet, is known as being half-open.
- Finally, when a legitimate user tries to access the server, the SYN flood attack has left all its connections exhausted, denying the user access. 
<img width="1999" height="776" alt="15ca2769-21d6-4312-abd6-51650bac00e8" src="https://github.com/user-attachments/assets/b0c3a2c1-2a8e-4a38-9109-2520a69c2739" />

- NetFlow data can uniquely distinguish a SYN flood from other types of DoS/DDoS attacks by using the TCP Flags field as an indicator.
- This field is exported as a number. At first glance, the use of a number seems unintuitive, but in practice it allows more information to be included without the use of lengthy strings.
- Decoding the TCP Flags field involves counting binary numbers.
- The TCP flags (URG = Urgent, ACK = Acknowledge, PSH = Push, RST = Reset, SYN = Synchronize, and FIN = Finish) correspond to numbers, as depicted below: 
<img width="1999" height="208" alt="2673928e-8b92-42f6-8333-2e0f76d099f3" src="https://github.com/user-attachments/assets/0a881746-33b3-4f51-9923-154711652b08" />

- To determine which TCP flags are included in the flow, the columns are counted from left to right.
- Because each flag equates to a binary number, they are added together to get the value for the flag.
- For example, a flag with a value of 2 means that the flow has only SYN flags. Additionally, a flag with a value of 17 corresponds to ACK and FIN. 
- This identification of TCP flags can be used in detecting SYN flood attacks, as large amounts of SYN messages are sent.
- Examination of NetFlow data generated during a SYN flood shows large amounts of TCP Flags fields that contain the value 2.
- Using the method of decoding from above, this shows that only a SYN flag was included in the flow. 

#### SYN-ACK Flood
- SYN-ACK floods, like SYN floods, target the server instead of another client.
- In this case, the attacker sends SYN-ACK packets at a high rate to the server.
- When the server receives these packets, significant amounts of processing power are required to determine why these packets are being received out of order (because it is expecting a SYN packet first).
- This high-resource consumption can deny service to legitimate users.   
- Identifying SYN-ACK floods using NetFlow is similar to identifying a SYN flood. Using the TCP flags of the flow, seeing disproportionately high numbers of SYN-ACK flags is a key indicator of the attack. 

#### Amplification DNS Flood
- All amplification attacks rely on the ability of a single system to generate small requests with low effort (low bandwidth, processing power, and memory) and cause a server to generate large, high-effort responses.
- This imbalance of proportions can be exploited in various attacks. 
- In an amplification DNS flood attack, multiple bots are employed by a single attacker.
- Each bot spoofs the IP address of a single victim and proceeds to generate high volumes of requests to a DNS resolver.
- To cause as much traffic congestion as possible, the attacker crafts the DNS request to generate a large response.
- When the bots send requests to the DNS resolver, the massive quantities of traffic are actually sent to the legitimate victim’s IP address, not the attacker’s systems, which are spoofing the address.
- The act of impersonating a victim’s IP address and then having a server send its responses to the actual victim’s IP address is known as reflection.
- This attack can be further modified by sending requests to multiple DNS servers, which all point their responses to the single victim’s machine.
- The result is a massive influx of DNS traffic to the victim’s system, causing a denial of service. 
- DNS flood attacks can be seen in NetFlow by observing the volume of DNS requests and responses.
- Although abnormally high numbers of requests can indicate a DNS flood, the proportion and size of the responses can be a key indicator of an amplification attack using DNS.
- Additionally, DNS floods show high amounts of User Datagram Protocol (UDP) traffic, as the protocol is connectionless and can be spoofed easily. 
<img width="1999" height="1206" alt="7b254876-9875-408e-8405-bb41a91bc4ab" src="https://github.com/user-attachments/assets/02db1f1b-5258-4c56-9533-e9579f492ed7" />

#### Amplification Reflection SYN-ACK Flood
- Amplification reflection SYN-ACK floods operate on the principles of both amplification attacks and reflection attacks.
- In this type of attack, a threat actor spoofs a victim client’s IP address and then sends SYN packets to a server.
- Unlike a SYN flood, in which the attack targets the server itself, a SYN-ACK flood attack targets another client.
- Once the server receives the SYN packets, it attempts to respond to them by sending SYN-ACK packets to the victim’s machine (whose IP address is being spoofed by the attacker).
- Like other amplification attacks, the attacker can send multiple SYN packets to multiple servers, which all concentrate their SYN-ACK responses to the same client. 
- Detecting an amplification reflection SYN-ACK flood with NetFlow data is similar to detecting a SYN flood.
- However, both the SYN-ACK and SYN counts are abnormally high. Under normal circumstances, the SYN, SYN-ACK, and ACK counts constitute a roughly 1:1:1 ratio.
- In a SYN or SYN-ACK flood, the SYN and SYN-ACK numbers are significantly higher than the number of ACK responses. 

<img width="779" height="320" alt="image" src="https://github.com/user-attachments/assets/060f2aa1-2a19-4108-a420-9b753154d356" />

<img width="748" height="383" alt="image" src="https://github.com/user-attachments/assets/8c2a87f1-bcce-4a2e-80d1-6e1050f97592" />

### Mitigating DoS Attacks
- Two DoS attacks were identified in the preceding questions.
- The use of NetFlow data has assisted in identifying the presence of a DoS attack as well as analyzing the specific type of DoS within the network.
- The final step in this process is to identify mechanisms for mitigation.
- These controls help reduce the chances of future attacks of the same nature. 

#### SYN-ACK Flood
﻿- For the time range Jun 3, 2021 @ 23:58:00.000 to Jun 4, 2021 @ 00:00:00.000, the NetFlow data showed that a SYN-ACK flood occurred.
- This was identified by two examples in the data.
  - First, there was only one destination IP, but there were dozens of source IP addresses.
  - Second, the ratio of SYN to SYN-ACK to ACK was massively disproportionate.
    - There were only one SYN packet and three ACK packets, but there were 6,650 SYN-ACK packets.
- These two pieces of evidence show that the attacker in this scenario spoofed multiple IP addresses and then overwhelmed the destination with SYN-ACK packets.
- The server consumes resources while trying to determine why SYN-ACK packets, rather than SYN packets, are arriving first.

- To mitigate this SYN-ACK flood, DoS/DDoS prevention software can be **configured to drop out-of-order SYN-ACK responses** that cause servers to become overwhelmed.
  - Additionally, **tweaking the connection timeout of servers** to prevent exhaustion avoids slowdowns. 

<img width="780" height="312" alt="image" src="https://github.com/user-attachments/assets/a635e800-44f0-4033-b91a-19763901787e" />



#### DNS Flood 
﻿- For the time range Jun 11, 2021 @ 18:28:00.000 to Jun 11, 2021 @ 18:30:00.000, the NetFlow data showed that a DNS flood occurred. 
- This attack was identified by three examples in the data. 
  - First, nearly all traffic in the NetFlow data was UDP rather than TCP.
    - This is a key indicator in a DNS flood, as UDP is connectionless and easier to spoof than TCP.
  - Second, and most obvious, is the high count for DNS traffic in the data.
    - This shows that the attacker was rapidly sending DNS requests through the network.
  - Third, there were dozens of source IP addresses and only one destination IP address. This indicates that the attacker spoofed IP addresses and then sent DNS queries to the single server. 

- To mitigate a DNS flood, well-known techniques may be employed.
- The first mitigation is to **disallow unsolicited DNS responses**.
  - In a legitimate DNS query, a resolver makes a request to a server, and the server sends a response to the resolver.
  - In the case of a DNS flood, the attacker sends responses to a resolver without any requests in the first place.
  - By blocking unsolicited responses, this attack can be reduced.
  - Second, **dropping rapid retransmissions from the same IP address** prevents single spoofed IP addresses from making a large impact.
  - Following this, **enabling a timeout on responses to individual queries** prevents the resolver from becoming overloaded with responding to every malicious request. 
<img width="705" height="350" alt="image" src="https://github.com/user-attachments/assets/c4b09fea-7a04-4d41-8514-d6f245fd8463" />


# MOD 12
## Distributed Network Architectures
### Distributed Network Architecture
- In a distributed network architecture, network devices and resources are divided over several smaller networks.
- Examples of “smaller networks” include single branch locations or buildings within a larger enterprise.
- In addition to distributing the network architecture and components, a distributed network architecture model allows the placement of systems closer to those that use them, which has the potential to decrease overall network utilization while increasing performance to end users.

- Distributed networks rely heavily on **routing** and **switching** protocols, as **each section** of a distributed network is effectively **its own network segment** connected to a larger, overarching network.
- Without the use of routing protocols, changes made in one network segment would not automatically be pushed into other segments of the network.
- This would require significant manual intervention in updating routing information on other network segments.
- Additionally, manual configuration of routing is susceptible to human error, as incorrect configurations can cause significantly adverse impacts to the network at large.

- Within individual network segments, switching protocols are also of importance.
- It is common to have multiple switches in use on a single network segment.
- The use of switching protocols ensures that such phenomena as switching loops do not occur.

<img width="621" height="521" alt="84e5ad82-a769-4d42-9241-ce85bb6ae241" src="https://github.com/user-attachments/assets/a0df0510-aaa1-4879-b52b-d06574afbace" />

### Distributed Network Routing
- Distributed networks rely on dynamic routing protocols to ease the configuration burden on network administrators.
- Dynamic routing protocols are split into two categories:
  - Interior Gateway Protocols (IGP)
    - IGPs are dynamic routing protocols intended for use within a single routing domain.
    - These are the most common protocols used within enterprise networks.
    - The IGP protocols Router Information Protocol (RIP) and Open Shortest Path First (OSPF) are explained in this lesson, but there are numerous other IGP protocols as well, such as Intermediate System to Intermediate System (IS-IS), Interior Gateway Routing Protocol (IGRP), and Enhanced Interior Gateway Routing Protocol (EIGRP).
      ##### Routing Information Protocol (RIP)
      - RIP is one of the earliest-developed dynamic routing protocols.
      - RIP is a distance-vector routing protocol that uses hop count as the primary routing metric and uses UDP port 520.
      - Hop count is a simple metric that represents how many routers traffic travels through on the way to its destination.
      - In the case of RIP, traffic is routed based on the route with the smallest number of hops to the destination.
        <img width="393" height="253" alt="897a95a6-7976-4e1d-ae0d-6cc059b26afb" src="https://github.com/user-attachments/assets/8f3d5773-ad33-479e-adaa-058f50e54492" />
         - Three paths exist between R1 and R8:
          - Red path (solid line): Traverses through two routers, a total of three hops.
          - Green path (dashed line): Traverses through one router, a total of two hops.
          - Blue path (dotted line): Traverses through three routers, a total of four hops.
        - Because RIP routes traffic based on the smallest number of hops, the green path (dashed line) is the chosen route in this scenario.
      ##### Open Shortest Path First
      - OSPF is a link-state protocol.
      - A link may be thought of as an interface on an OSPF-enabled router.
      - The collection of all link-states constitutes the Link-State Database (LSDB).
      - OSPF does not use a transport protocol and encapsulates its traffic directly in Internet Protocol (IP) packets using protocol number 89.
      - Cost is the metric used in OSPF routing to determine the best path to a destination.
      - In an OSPF implementation, each interface of a router has a cost value.
      - The cost is directly related to the bandwidth of an individual interface.
      - The higher bandwidth an interface has, the lower its cost is.
      <img width="393" height="253" alt="d034590e-b5ce-436a-85b7-62fa8871d576" src="https://github.com/user-attachments/assets/e4056c36-fdaa-4b2c-81c7-03f9df9d8050" />
          
          - Three paths exist between R1 and R8:
            - Red path (solid line): Traverses through two routers; the cumulative link cost is 30.
            - Green path (dashed line): Traverses through one router; the cumulative link cost is 40.
            - Blue path (dotted line): Traverses through three routers; the cumulative link cost is 35.
        - In the above OSPF scenario, the red path (solid line) is the best route between R1 and R8, as its cumulative link cost between all routers is the lowest.
        - Even though only one router is between R1 and R8 on the green path (dashed line), the link costs are significantly higher than the red path (solid line).
        - This is likely due to the links on the red path (solid line) having lower bandwidth capabilities.
        - When updating the topology, each router places itself at the root of a tree and calculates the shortest path to each destination based on cumulative cost to reach the destination.
        - This causes each router to have its own topology view, as the shortest path to a destination may be different from different routers.
        - Figure 12.2-4 shows an example of the shortest path tree seen from the perspective of five different interconnected routers.
          <img width="602" height="1109" alt="4d6c9f61-d5d3-433f-ba87-091508b436fb" src="https://github.com/user-attachments/assets/d340be64-f50f-401d-bdee-5c6f36ff1089" />

  - Exterior Gateway Protocols
    - EGPs are routing protocols designed for routing traffic across large-scale networks, such as the internet.
    - Although EGPs are most commonly used on the internet backbone, they may also be used within large enterprise networks.
    ##### Border Gateway Protocol
    - BGP is the premier protocol used throughout the internet and large-scale enterprise networks for routing between Autonomous Systems (AS).
    - BGP is a path-vector protocol that determines the best path to a destination based on available paths and preconfigured rules.
    - Path Attributes (PA) are assigned variables (the rules) that routers use to determine the best path to a destination network.
    - BGP enables routers to exchange information about network prefixes under the responsibility of an AS. In BGP, updates are sent only when changes occur.
    - BGP works by establishing paths, which are a sequence of Autonomous System Numbers (ASN) that traffic must be routed through to reach a destination network.
    - When a BGP router advertises a new network, BGP peers receive the advertisement and append their ASN to the AS_PATH variable of the BGP message.
    - This update is then sent to neighboring BGP peers, which perform the same process.
    - The end result is that, through BGP, routers can determine what paths are available to a destination.
    - Figure 12.2-5 demonstrates how the AS path value is modified as it propagates through BGP peers:
      <img width="721" height="421" alt="8de9df3c-d5ed-4083-9044-e8da043beb05" src="https://github.com/user-attachments/assets/7519c669-b869-4598-ac80-972b1d15e9fc" />
        - In Figure 12.2-5, AS 62262 advertises that it is now the AS for the network 64.210.1.0/24.
        - This route change is advertised to BGP neighbors.
        - The neighboring AS 174 receives the advertisement, appends its ASN to the beginning of the AS_PATH value, and sends an update to its neighbors.
        - In this manner, a full path is generated between AS 62262 and AS 6939.

### Distributed network Switching
#### Spanning Tree Protocol
- In large and distributed networks, it is common for multiple switches to be interconnected.
- Because switches still allow packets to be broadcast to all ports when intended, switched networks are susceptible to broadcast storms when multiple switches are interconnected with redundant connections.
- In the case of interconnected switches, a broadcast storm occurs when a frame marked for broadcast is broadcast out of all ports of a switch and the broadcast repeats through the series of interconnected switches.
- A broadcast storm can consume sufficient network resources to render the network unable to transport normal traffic. 
<img width="392" height="294" alt="b78b91c1-c156-42de-85c1-6acbba1f3064" src="https://github.com/user-attachments/assets/e345ebc1-7edb-4d6c-ae6f-1d9f91fe2390" />

- In Figure 12.2-6, a broadcast packet is sent from a workstation to a switch, and each iteration of the packet is noted by a number in the drawing.
- The switch (interconnected with two other switches) broadcasts the packet out of all ports.
- Each of the two interconnected switches receives the packet and then broadcasts the packet again.
- Due to the presence of a loop in the switching topology, the broadcast continues indefinitely.
- STP was introduced to switching environments to solve this problem.
  - STP is a switching protocol that builds a loop-free topology of an Ethernet network.
  - STP works by creating a tree based on its relationship to other bridges and determining a single path to forward traffic through the topology while blocking traffic on redundant paths that could cause a loop.
  - In STP, switches communicate with their neighbors in the Local Area Network (LAN) using Bridge Protocol Data Units (BPDU).
    - BPDUs are the data frames that contain information about STP and are used to transfer STP information between switches. They are sent by switches on a regular interval.
  - The first goal of STP is to identify the root bridge in the topology.
    - When a switch comes online, it assumes itself as the root bridge and proceeds to use its local bridge ID as the root bridge ID.
      - The bridge ID is a concatenation of the bridge priority (a configurable value on most enterprise switches) and the Media Access Control (MAC) address of the switch.
    - The switch then listens for BPDUs from neighbor switches and performs the following:
      - If the switch receives a BPDU with a higher bridge ID, the ID is ignored and the switch continues to see itself as the root bridge.
      - If the switch receives a BPDU with a lower bridge ID, the switch updates its BPDUs to include the new root bridge ID (the switch with the lowest bridge ID) along with an updated root path cost to reach the new root bridge.
    - The above process continues until all switches in the topology have identified the root bridge switch.
<img width="471" height="431" alt="c618bd18-450f-4586-8812-548187adf01a" src="https://github.com/user-attachments/assets/c91c1cbe-da1b-48b5-bc22-021b60343e69" />

- Figure 12.2-7 shows four interconnected switches and the default bridge priority, MAC address, and resulting bridge ID of each switch.
- All the switches shown are using the default bridge priority, which means the root bridge is determined by selecting the switch with the lowest MAC address.
- In the figure, this is switch C, as its MAC address is a lower value than all the other switches.
- If a network administrator desired a specific switch to be designated as the root bridge, the value of the bridge priority would need to be decreased on that bridge so that it would have the lowest bridge ID.

- Once the root bridge has been elected, non-root switches need to determine the root port.
- The root port is the port used by a switch to forward packets toward the root bridge.
- Each switch determines the root port by identifying the port with the lowest path cost to the root bridge.
- Ports on a switch that facilitate a path to the root bridge for other switches are called designated ports. 
<img width="711" height="221" alt="91651334-b8d6-4ae2-9701-64974a8eb622" src="https://github.com/user-attachments/assets/50a1f394-93d9-4737-b9ce-f5278deb3ee5" />

- Figure 12.2-8 shows the root bridge SW1 sending BPDUs with the path cost to the root bridge to SW2 and SW3.
- SW2 is shown sending a BPDU with the total path cost to the root bridge to SW3.
- Using the information from the BPDUs received at SW3, SW3 designates the lowest cost path (directly to SW1) as the root port (shown as RP in the figure).
- SW2 also designates the path directly to SW1 as the root port.
- The port from SW3 to SW2 is set to a blocking state (shown as B in the figure), as this is a higher cost path to the root bridge and having it enabled would introduce a switching loop.
- Ports in a blocking state are not used to forward any traffic from the switch.
- However, BPDUs continue to be sent on this port so switches are constantly aware of the topology and can adapt to changes dynamically.

- STP is a legacy protocol and has been replaced with newer protocols that accomplish the same goal in most networks.
- However, newer protocols simply build on the foundation of STP and enhance its capabilities.
- Rapid Spanning Tree Protocol (RSTP) is a common and newer implementation of STP that significantly speeds up the functions of STP.
- Whereas STP may require 30 seconds or more to respond to topology changes, RSTP can adapt in less than 3 seconds.
- Cisco switches commonly employ a proprietary standard called Per-VLAN Spanning Tree (PVST) that allows Cisco switches to build separate spanning trees for each Virtual Local Area Network (VLAN) configured on a switch.
- Multiple Spanning Tree Protocol (MSTP) is similar to PVST and incorporates spanning trees for use on VLANs; it is not a proprietary protocol.
- Shortest Path Bridging (SPB) combines technologies from many of these switching protocols and allows for multiple equal cost paths to be active at the same time. 

<img width="766" height="314" alt="image" src="https://github.com/user-attachments/assets/5585da63-cfc6-4d49-a888-153156929837" />


### Distributed Network Architecture and Sensor Placement
#### Sensor Placement Considerations
- The objectives of an engagement must be understood and applied to determine proper sensor placement in a distributed network environment.
- The following questions help to determine proper placement of sensors.

##### What should be avoided in a switched network topology?
- A mission may require the placement of sensors to capture network traffic between devices on the same network segment.
- If the network segment contains multiple interconnected switches, careful consideration must be given to the implementation of network taps and Switched Port Analyzer (SPAN) ports, as STP may impact how packets move between switches. 

<img width="711" height="221" alt="d9dc94ca-ed2a-487b-962c-69e09fcf7419" src="https://github.com/user-attachments/assets/18738afc-5915-4f87-aeea-576d14cc6a96" />

- Figure 12.2-9 shows a network tap placed inline between SW2 and SW3.
- Because STP has designated SW1 as the root bridge and SW2 and SW3 have a direct path to SW1, the implementation of the tap between SW2 and SW3 is not effective.
- Because SW3 has set its port toward SW2 in a blocking state, only STP traffic traverses through the network tap. Standard user traffic is not captured.

<img width="711" height="222" alt="e6b80567-726a-4564-944d-a0700f6ff426" src="https://github.com/user-attachments/assets/3c8e75bd-c040-4e27-8deb-7ee3aa3bf23d" />

<img width="711" height="222" alt="252b637b-5b24-4828-8e58-909df29f5a30" src="https://github.com/user-attachments/assets/8fe03d4f-2bc9-4281-a4b0-8038dc1d0be4" />

- In Figure 12.2-10, the implementation of network taps between SW1 and SW2 and between SW1 and SW3 ensures that intra-network traffic between switches is captured, as the links the taps are implemented on are the designated paths determined by STP.
- In STP, because all traffic destined for another switch is forwarded up to the root bridge, an alternative approach is to implement a SPAN port on the root bridge switch and connect it to a sensor, as shown in Figure 12.2-11.

##### What should be avoided within a routed network topology?
- When traffic capture in a distributed architecture is desired, thought must be given to the operation of routing protocols that are in use within the environment.
- When multiple routers are interconnected, multiple paths may exist between points within the network. 

<img width="551" height="552" alt="a91e1a70-6f00-4994-8b13-6d73a9e1efd4" src="https://github.com/user-attachments/assets/840dae97-5775-4cff-97a4-02b519efa693" />

- Figure 12.2-12 illustrates a distributed network topology.
- OSPF is used within the routing environment shown.
- A mission objective requires capturing and monitoring traffic between routers r1 and r3.
- The OSPF shortest path between the two routers is shown by the green path (dashed line) through router r2.
- Given that only traffic between r1 and r3 is of importance given the objective, a network tap could be implemented on either segment of the shortest (green, dashed-line) path to capture all traffic between r1 and r3.

- Because changes may occur within a routing topology, consideration must be given to the placement of sensors.
- In Figure 12.2-12, assume that the link between r2 and r3 is severed and that the next shortest path (based on OSPF routing) from r3 to r1 is through r5 to r1. In this scenario, placing an additional sensor, such as a network tap, on this path would be ideal to capture traffic when the primary shortest path is severed.

##### What are the trust boundaries?
- Trust boundaries are connections between trusted and untrusted networks or between two networks with different levels of trust and security.
- Trust boundaries are often ideal sensor placement locations, as placing sensors in this location provides the ability to capture all traffic for analysis that ingresses and egresses the trusted zone. 


#### Distributed Network Sensor Placement
- Answering the questions from the previous section guides analysts in determining the ideal placement for monitoring sensors. 

<img width="713" height="513" alt="83e5182b-d367-425f-b015-aa29613cef16" src="https://github.com/user-attachments/assets/77405547-91bc-4ae5-ab70-fb6bb63f5043" />

- Figure 12.2-13 shows a distributed architecture with three switching domains and a routing domain between them.
- Switches that have been elected as the root bridge via STP are marked in red.
- The routers r1, r2, and r3 all perform Network Address Translation (NAT) and use private addresses for the workstations interior to each network segment.

- Consider intelligence for a mission that states that malicious traffic has been observed within the network behind r2.
- Systems within the network behind r2 have been observed making network connections to systems in the network behind r3, which is abnormal behavior.
- The objective of the mission is to place sensors within the switching domains behind r2 and r3 to capture intra-network traffic and to place sensors within the routing domain to capture traffic between r2 and r3.
- The objective also states that traffic should be captured from the interior and exterior perspectives from r2.
- In the switching domain behind r2, the use of network taps is preferred, as this is the origin of the known malicious traffic, and ensuring packets are not lost is critical to the mission.
- (SPAN ports on switches may experience packet drops if the switch becomes overloaded. This does not occur with taps.)

- Given this scenario, sensors may be applied to the architecture, as shown in Figure 12.2-14:

<img width="713" height="563" alt="c2c39678-c61d-4107-9306-bfc51a21e9cc" src="https://github.com/user-attachments/assets/277570e1-5151-4fe7-bb43-d1cc56ba0a07" />

  - Placing a network tap behind r2 ensures that traffic is captured as it enters or leaves the network behind r2 while keeping interior addressing intact.
  - The route behind r2 and r3 is a directly connected route and is used to steer traffic between the networks. A tap at this location ensures that traffic between the networks is captured.
  - Although it is not the shortest path, placing a sensor between r3 and r4 is prudent, as this is the link that is used to route traffic between r2 and r3 if the link between those routers is severed.
  - Implementing a tap between the root bridge switch and the other two switches in the switching domain behind r2 ensures that intra-network traffic between the switches is captured.
    - Placing a tap between the non-root bridges is not an ideal placement, as this would
  - be a blocked path by STP and would carry only STP traffic. Additionally, the use of taps instead of SPAN ports ensures that all traffic is captured, even in the event the switch becomes overloaded.
  - A SPAN port is implemented on the root bridge switch behind r3. The SPAN port may be configured to mirror all traffic from both switches.

<img width="603" height="599" alt="image" src="https://github.com/user-attachments/assets/2b8a3101-9a6f-4380-a67d-70067574cf46" />

<img width="772" height="346" alt="image" src="https://github.com/user-attachments/assets/a4da38e4-7e4a-4905-b734-7bd0c7c4c875" />

<img width="752" height="322" alt="image" src="https://github.com/user-attachments/assets/a58b5e50-785d-41c5-bb82-33d09fde705e" />

<img width="762" height="293" alt="image" src="https://github.com/user-attachments/assets/c5347b11-9af6-4ba3-93cb-bd4498bd1608" />


## Prioritizing Capture Locations
### Capturing Known Threats
- Adversaries in cyberspace may have objectives that target specific industries or organizations, and organizations involved in industries similar to each other may have commonalities in their attack surfaces.
- For example, the energy sector is commonly targeted by threat actors.
- Because organizations in this sector conduct industrial operations, their Operational Technology (OT) networks are a likely target for adversaries.
- For other industries, such as manufacturing, the data within an organization (such as manufacturing plans and drawings) may be of more value to an adversary.
- Understanding an organization’s attack surface in tandem with analyzing intelligence on threat actors can guide analysts in implementing effective monitoring controls based on the operation of the organization.

- Using Cyber Threat Intelligence (CTI), attacks from tracked threat groups may be broken down into patterns of behavior.
- Using this information, analysts can identify key areas in which attacks are more likely to occur, which can guide the effective placement of monitoring sensors and controls.

- Consider the following examples of CTI and Tactics, Techniques, and Procedures (TTP) and how sensors and collection techniques may be implemented to identify potential Malicious Cyber Activity (MCA):

#### Example 1
- **CTI**: A threat actor is known to use phishing emails and establish Command-and-Control (C2) channels to an external C2 infrastructure.
- **TTP**: Place network sensors between user network segments (where target workstations reside) and the edge firewall.
  - Placing sensors internal to the network keeps internal addresses intact, allowing compromised systems to be easily identified.
  - Placing sensors between the firewall and each network segment used by end users ensures full sensor coverage across all potential target workstations.

#### Example 2
- **CTI**: A threat actor is known to use brute force attacks on Virtual Private Network (VPN) endpoints at the network boundary to gain access to a network.
- **TTP**: Collect logs from the network boundary device or edge firewall. Connection logs on these devices may indicate attempts at gaining access to the network.

#### Example 3
- **CTI**: A threat actor is known to target vulnerable services on public-facing web servers and use those vulnerable services to compromise systems and establish C2 channels.
- **TTP**: Place a sensor on the link between the edge firewall and the Demilitarized Zone (DMZ).
  - A sensor in this location allows any potential MCA directed toward the public-facing web server to be captured.
- **TTP**: Collect logs from the network boundary device or edge firewall.
  - CTI may be applied to connection logs to identify if attacks are being attempted or have already occurred.

- Given the examples above, consider the following intelligence:
  - The Advanced Persistent Threat APT41 is assessed to be actively attacking healthcare organizations.
  - Intelligence analysts assess that C2 infrastructure exists in the 104.53.200.0/24 range, and observed TTPs indicate that phishing emails are used for initial compromise and Domain Name System (DNS) is used for C2 communications.
-
- Figure 12.3-1 indicates sensor placement and collection techniques that can capture this activity:

<img width="671" height="632" alt="0b65b550-6718-4a5a-b74c-58555f5b2fb5" src="https://github.com/user-attachments/assets/17715d65-bf7d-43d8-8e18-40552e82377b" />

- Figure 12.3-1 indicates a compromised workstation in the Accounting subnet.
- The compromised workstation is using DNS as a C2 channel to the attacker system, indicated by the red path through the network.
- The callout 1 indicates a sensor placed between the core router (core-rtr) and the Services segment that contains the internal DNS server.
- This is an ideal placement for a sensor, as it captures all internal DNS traffic that can be further inspected for potentially malicious DNS traffic.

<img width="587" height="643" alt="image" src="https://github.com/user-attachments/assets/bb3f23e2-6e48-435a-8d3e-6876cce55162" />

### Internal and External Traffic
- Placing too many sensors on a network may cause the same data to be captured multiple times.
- This consumes resources for storage and also increases the amount of data that analysts must sift through.
- On the other hand, not placing enough sensors on a network may cause important data to be missed.
- Thought should always be given to mission objectives to determine the best placement of sensors.

- Private networks may be divided into two sections: external and internal.
- A firewall or router at the edge of the private network is typically the demarcation point between these two segments.
- The edge device typically performs Network Address Translation (NAT) between the external and internal networks and is also responsible for determining what traffic is allowed to traverse the boundary.
- The nature of traffic internal to a network is also significantly different from that on the external side of the network, and placement of sensors in these two locations may have differing outcomes.

#### External Sensors
- The external section of a network is the connection to an organization’s Internet Service Provider (ISP) or a backbone network service.
- Placing sensors external to the network can provide valuable information, but pitfalls must be considered to ensure that data collection from external sensors is effective:
  - Because an external sensor is exterior to the boundary of a network, it can capture all traffic visible to the external interface of the network boundary devices.
    - This includes legitimate traffic but also traffic that does not belong to an established session within the network (such as network reconnaissance or malicious activity).
  - External sensors are prone to false positives.
    - An external sensor observes all traffic destined to the network, regardless of whether it is legitimate traffic. In scenarios in which an edge firewall is blocking malicious activity, an alert is still generated on an external sensor.
  - When NAT is in use between the internal and external sides of the network, an external sensor sees only the global addresses associated with traffic.
    - To see local addresses for traffic inside the network, an internal sensor must be used.

#### Internal Sensors
- Internal sensors may be implemented to capture intra-network traffic and to capture traffic as it moves toward the network boundary.
- Capturing traffic inside the network boundary also ensures that the captured traffic contains the internal local addresses associated with the traffic.
- Consider the following network diagram:

<img width="551" height="492" alt="17d292ea-97af-4de3-8d75-16c0ff211ba3" src="https://github.com/user-attachments/assets/244169bf-61b9-4c01-abd1-4db11c25d39d" />

- When mission objectives require capturing internal traffic before it leaves the network, a sensor on the segment just inside the network boundary is an ideal placement.
- A sensor in this location ensures that all traffic entering or leaving the network is captured from an internal perspective (including local Internet Protocol [IP] addresses associated with the traffic).
- CTI may be applied to information captured at this sensor to help determine if malicious activity is occurring between internal hosts and malicious actors.
- Although the sensor placement in Figure 12.3-3 is ideal when it is necessary to monitor all traffic moving to or from the network boundary, the single sensor alone does not provide a complete picture of network activity.
- Consider a threat actor who has compromised a system in the Engineering network because a user opened a malicious email attachment.
- The malicious payload attempts to make lateral movement to systems located in the Accounting and Processing networks.
- Although a sensor exists between core-rtr and edge-fw that would capture any C2 communications, network traffic illustrating lateral movement to the Engineering and Processing networks would not be captured, as no sensors exist between these segments.
- Consider another example provided in Figure 12.3-4, which is updated from Figure 12.3-3:

<img width="551" height="552" alt="0722cabc-9d54-468d-92f9-9a94ce5b510b" src="https://github.com/user-attachments/assets/f99d6994-b0c0-4c72-a8a2-99d1c19a7f7e" />

- Figure 12.3-4 indicates the addition of a sensor between the Engineering network segment and core-rtr.
- Placing a sensor in this location allows attempted lateral movement to other network segments to be captured.
- In the event that workstations in other segments become compromised, the presence of the sensor between core-rtr and edge-fw ensures that potential C2 communications are captured and would further drive placement of additional sensors as required.

<img width="694" height="319" alt="image" src="https://github.com/user-attachments/assets/df2271d0-807e-44fb-b18c-27644b482741" />

### Applying Internal vs. External Sensors
- Capturing traffic on an internal network may provide information to determine presence of malicious activity inside the network, but it does not provide a complete picture of all activity.
- Internal sensors cannot provide insight into activity that is attempting to penetrate the network boundary. 

- Edge firewalls and monitoring sensors exterior to the network provide valuable information on potential MCA that cannot be obtained using internal sensors and data points alone.
- Firewall logs are a great source of data when identifying penetrations of the network boundary, as they log activity that is both allowed and rejected.
- Information for both allowed and rejected connections can be used to pivot and correlate data from other sensors throughout the network infrastructure.

- Placement of external sensors can provide CTI that becomes a critical tool for analysts.
- Using external sensors, analysts can accomplish the following objectives:
  - Identify scanning of the network boundary.
  - Identify adversarial tactics attempted before the network is breached.

- External sensors can provide valuable information, but they must be tuned properly to collect useful and actionable information while keeping noise and false positives to a minimum.
- For this reason, external sensors should implement filtering so that only explicitly intended traffic is captured for analysis.

- Consider the following CTI:
  - _An adversary has been observed using brute force techniques in an attempt to gain access to externally accessible VPN endpoints._
  - _The adversary is known to use systems within the range 104.53.200.0/24, and the Hypertext Transfer Protocol Secure (HTTPS) landing page for the VPN gateway is being targeted._ 

- Below are a few examples analysts can follow to tune external sensors so that activity as indicated in the CTI is monitored for:
  - External sensors capturing Packet Capture (PCAP) files may be configured with Berkeley Packet Filters (BPF) so that only traffic from the assessed malicious IP space, or traffic to the HTTPS VPN endpoint, is captured.
  - Firewall logs may be filtered to identify any connections from the assessed threat actor’s IP space.
  - External sensors may be configured to filter traffic destined to the threat actor’s IP space to determine if a compromise has already occurred.

<img width="774" height="370" alt="image" src="https://github.com/user-attachments/assets/ee2a6d51-bb9b-4c09-adc8-3b24d0b7b613" />

<img width="771" height="400" alt="image" src="https://github.com/user-attachments/assets/bc30ad05-cf00-4363-8100-380a98c9d37f" />

<img width="667" height="341" alt="image" src="https://github.com/user-attachments/assets/c25ff031-80be-4672-9155-32215e7dd4b0" />

<img width="729" height="445" alt="image" src="https://github.com/user-attachments/assets/14dd7f45-458c-45ff-b5d7-59107cc0cef2" />


## Internal Threats
### Internal Data Sources
- Observation of internal threats requires effective deployment of internal network sensors.
- This lesson comprises a lab exercise in which analysts access and analyze information captured from network sensors to identify active threats within the network.
- The lab uses the attached documents. One document provides a network topology map, and one document provides a list of TTPs associated with a specific Advanced Persistent Threat (APT) group and a list of network assets.
- In the network map, internal sensors (called onion sensors) are placed between the core router and the edge firewall and between the core router and all other network segments.
- The placement of sensors in this manner ensures a complete picture of internal network traffic. Because this exercise focuses on identifying threats internal to the network, no external sensors are leveraged.
















  
