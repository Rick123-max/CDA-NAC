# MOD 11
## Anomaly Detection
### NetFlow Search Query Basics
<img width="1999" height="1394" alt="150ccb94-fa9c-4c90-a77f-6fc344e98d94" src="https://github.com/user-attachments/assets/eac69f8a-ca97-4f17-93b3-a9a2ba49f229" />

#### Understanding NefFlow Data in SecOnion
- Network devices (such as routers or switches) using protocols like **NetFlow v5**, **NetFlow v9**, or Internet Protocol Flow Information Export (**IPFIX**), send data to a collector.
- For Security Onion, that collector is **Filebeat** (specifically collected through Filebeat’s NetFlow module). 

#### NetFlow Data Ingestion
- The Filebeat NetFlow module listens on a configured port ([UDP] or [TCP]) for incoming raw NetFlow data from these devices.
- When NetFlow records arrive, the Filebeat NetFlow module **normalizes and enriches** them into one of the nine data types described above, saving the data into **netflow.log**.
- It then forwards the normalized records to Elasticsearch for long-term storage and analysis.

#### Log Generation and Processing
- Filebeat processes the incoming NetFlow data using a pipeline.
- For this lesson’s version of Security Onion, the pipeline is **filebeat-7.17-1-netflow-log-pipeline**. 
- The ingested NetFlow data is broken into hundreds of fields, depending on the NetFlow version and the values present in the data.
- Each field has an associated data type.
- For example, netflow.destination_ipv4_address is an ip type, and netflow.destination_transport_port is an integer type.

- The pipeline performs field extraction, parsing, and normalization to create structured records with predefined fields.
- Common fields that may be used to perform NetFlow queries include, but are not limited to, the following:
  - event.action: netflow_flow
  - event.dataset: netflow.log
  - event.module: netflow
  - flow.id: (random assigned id)
  - input.type: netflow
  - service.type: netflow
  - netflow.destination_ipv4_address
  - netflow.destination_transport_port

### NetFlow Search Queries
- View entire count of NetFlow data: `* | groupby event.dataset`
- Show Source IP with highest occurance: `* | groupby event.dataset netflow.source_ipv4_address`
- Add an additinal column for desination IP" `* | groupby event.dataset netflow.source_ipv4_address netflow.destination_ipv4_address`
- View source port numbers: `* | groupby event.dataset netflow.source_transport_port`
- Create a column of destination ports: `* | groupby event.dataset netflow.source_transport_port netflow.destination_transport_port`

#### NetFlow Queries Using Kibana
- Query for NetFlow data: `event.dataset: "netflow.log"`
  - Add the following fields to the output: `source.ip`, `destination.ip`, `source.port`, `destination.port`
- Refine search to identify IP addresses using port 0: `event.dataset: "netflow.log" and (netflow.source_transport_port: 0 and netflow.destination_transport_port: 0)`
- Search for flows larger than .095MB or larger than 100,000 bytes: `event.dataset: "netflow.log" and network.bytes > 100000`


## Identifying DDos Attack
### Denial of Service Identification
- The goal of a DoS attack is to prevent legitimate users from accessing a service or resource.
- This loss of access can range from a single service or machine to an entire network or multiple networks.
- There are many different categories of DoS attacks, each with their own characteristics and varying degrees of impact.
- A (DDoS) attack is a DoS attack that is launched from more than one attacker-controlled host.
- Hosts used in a DDoS attack might be from a large number of attackers coordinating their attack or from unwitting bots under the control of a single attacker.

- NetFlow data is useful in determining both the presence and magnitude of a DoS attack.
- Although an infinite number of possibilities exists, depending on the network and attack, several common attacks and indicators within NetFlow can be observed.
- Examples of attacks and indicators include high bandwidth/slow performance, Synchronize (**SYN**) floods, amplification Domain Name System (**DNS**) floods, and amplification reflection Synchronize-Acknowledge (**SYN-ACK**) floods. 

#### High Bandwidth and Slow Performance
- Slow performance is an almost-universal sign of a DoS attack.
- Because the goal of a DoS attack is to deny service, causing resources to become disruptively slow is an acceptable outcome from an attacker’s perspective.
- DDoS attacks use multiple systems to overwhelm a target, so higher-than-normal levels of traffic are observed within NetFlow data.
- Depending on the type of attack, these elevated traffic levels may be seen as spikes at precise times or as continuous floods.  

#### SYN Floods 
- The well-known “three-way handshake” used when establishing a (TCP) connection is a frequent target of abuse in a DoS attack.
- Normally, a client sends a SYN message to a server, which then causes the server to reply with a SYN-ACK message.
- Upon receipt of the SYN-ACK message, the client sends an ACK message back to the server. 
<img width="1999" height="476" alt="b2dc2861-072d-4a0a-b64a-9bca7b5018e0" src="https://github.com/user-attachments/assets/2e377feb-3015-4c1c-96e7-f144732ae229" />

- A SYN flood takes advantage of the server’s willingness to send SYN-ACK responses to incoming SYN messages.
- An attacker rapidly sends large quantities of SYN packets to open ports on the target’s server.
- The unwitting server then begins to send SYN-ACK replies to the attacker.
  - However, the attacker’s Internet Protocol (IP) address is often spoofed or fake.
- This means that the SYN-ACK reply never reaches its intended client, and the victim server waits for the acknowledgement of the SYN-ACK with an open connection.
- Although the server can close the port by sending a Reset (RST) packet, another malicious SYN packet arrives before the server can do so, starting the cycle again.
- This state, in which the server awaits ACK packets and cannot close the ports with a RST packet, is known as being half-open.
- Finally, when a legitimate user tries to access the server, the SYN flood attack has left all its connections exhausted, denying the user access. 
<img width="1999" height="776" alt="15ca2769-21d6-4312-abd6-51650bac00e8" src="https://github.com/user-attachments/assets/b0c3a2c1-2a8e-4a38-9109-2520a69c2739" />

- NetFlow data can uniquely distinguish a SYN flood from other types of DoS/DDoS attacks by using the TCP Flags field as an indicator.
- This field is exported as a number. At first glance, the use of a number seems unintuitive, but in practice it allows more information to be included without the use of lengthy strings.
- Decoding the TCP Flags field involves counting binary numbers.
- The TCP flags (URG = Urgent, ACK = Acknowledge, PSH = Push, RST = Reset, SYN = Synchronize, and FIN = Finish) correspond to numbers, as depicted below: 
<img width="1999" height="208" alt="2673928e-8b92-42f6-8333-2e0f76d099f3" src="https://github.com/user-attachments/assets/0a881746-33b3-4f51-9923-154711652b08" />

- To determine which TCP flags are included in the flow, the columns are counted from left to right.
- Because each flag equates to a binary number, they are added together to get the value for the flag.
- For example, a flag with a value of 2 means that the flow has only SYN flags. Additionally, a flag with a value of 17 corresponds to ACK and FIN. 
- This identification of TCP flags can be used in detecting SYN flood attacks, as large amounts of SYN messages are sent.
- Examination of NetFlow data generated during a SYN flood shows large amounts of TCP Flags fields that contain the value 2.
- Using the method of decoding from above, this shows that only a SYN flag was included in the flow. 

#### SYN-ACK Flood
- SYN-ACK floods, like SYN floods, target the server instead of another client.
- In this case, the attacker sends SYN-ACK packets at a high rate to the server.
- When the server receives these packets, significant amounts of processing power are required to determine why these packets are being received out of order (because it is expecting a SYN packet first).
- This high-resource consumption can deny service to legitimate users.   
- Identifying SYN-ACK floods using NetFlow is similar to identifying a SYN flood. Using the TCP flags of the flow, seeing disproportionately high numbers of SYN-ACK flags is a key indicator of the attack. 

#### Amplification DNS Flood
- All amplification attacks rely on the ability of a single system to generate small requests with low effort (low bandwidth, processing power, and memory) and cause a server to generate large, high-effort responses.
- This imbalance of proportions can be exploited in various attacks. 
- In an amplification DNS flood attack, multiple bots are employed by a single attacker.
- Each bot spoofs the IP address of a single victim and proceeds to generate high volumes of requests to a DNS resolver.
- To cause as much traffic congestion as possible, the attacker crafts the DNS request to generate a large response.
- When the bots send requests to the DNS resolver, the massive quantities of traffic are actually sent to the legitimate victim’s IP address, not the attacker’s systems, which are spoofing the address.
- The act of impersonating a victim’s IP address and then having a server send its responses to the actual victim’s IP address is known as reflection.
- This attack can be further modified by sending requests to multiple DNS servers, which all point their responses to the single victim’s machine.
- The result is a massive influx of DNS traffic to the victim’s system, causing a denial of service. 
- DNS flood attacks can be seen in NetFlow by observing the volume of DNS requests and responses.
- Although abnormally high numbers of requests can indicate a DNS flood, the proportion and size of the responses can be a key indicator of an amplification attack using DNS.
- Additionally, DNS floods show high amounts of User Datagram Protocol (UDP) traffic, as the protocol is connectionless and can be spoofed easily. 
<img width="1999" height="1206" alt="7b254876-9875-408e-8405-bb41a91bc4ab" src="https://github.com/user-attachments/assets/02db1f1b-5258-4c56-9533-e9579f492ed7" />

#### Amplification Reflection SYN-ACK Flood
- Amplification reflection SYN-ACK floods operate on the principles of both amplification attacks and reflection attacks.
- In this type of attack, a threat actor spoofs a victim client’s IP address and then sends SYN packets to a server.
- Unlike a SYN flood, in which the attack targets the server itself, a SYN-ACK flood attack targets another client.
- Once the server receives the SYN packets, it attempts to respond to them by sending SYN-ACK packets to the victim’s machine (whose IP address is being spoofed by the attacker).
- Like other amplification attacks, the attacker can send multiple SYN packets to multiple servers, which all concentrate their SYN-ACK responses to the same client. 
- Detecting an amplification reflection SYN-ACK flood with NetFlow data is similar to detecting a SYN flood.
- However, both the SYN-ACK and SYN counts are abnormally high. Under normal circumstances, the SYN, SYN-ACK, and ACK counts constitute a roughly 1:1:1 ratio.
- In a SYN or SYN-ACK flood, the SYN and SYN-ACK numbers are significantly higher than the number of ACK responses. 

<img width="779" height="320" alt="image" src="https://github.com/user-attachments/assets/060f2aa1-2a19-4108-a420-9b753154d356" />

<img width="748" height="383" alt="image" src="https://github.com/user-attachments/assets/8c2a87f1-bcce-4a2e-80d1-6e1050f97592" />

### Mitigating DoS Attacks
- Two DoS attacks were identified in the preceding questions.
- The use of NetFlow data has assisted in identifying the presence of a DoS attack as well as analyzing the specific type of DoS within the network.
- The final step in this process is to identify mechanisms for mitigation.
- These controls help reduce the chances of future attacks of the same nature. 

#### SYN-ACK Flood
﻿- For the time range Jun 3, 2021 @ 23:58:00.000 to Jun 4, 2021 @ 00:00:00.000, the NetFlow data showed that a SYN-ACK flood occurred.
- This was identified by two examples in the data.
  - First, there was only one destination IP, but there were dozens of source IP addresses.
  - Second, the ratio of SYN to SYN-ACK to ACK was massively disproportionate.
    - There were only one SYN packet and three ACK packets, but there were 6,650 SYN-ACK packets.
- These two pieces of evidence show that the attacker in this scenario spoofed multiple IP addresses and then overwhelmed the destination with SYN-ACK packets.
- The server consumes resources while trying to determine why SYN-ACK packets, rather than SYN packets, are arriving first.

- To mitigate this SYN-ACK flood, DoS/DDoS prevention software can be **configured to drop out-of-order SYN-ACK responses** that cause servers to become overwhelmed.
  - Additionally, **tweaking the connection timeout of servers** to prevent exhaustion avoids slowdowns. 

<img width="780" height="312" alt="image" src="https://github.com/user-attachments/assets/a635e800-44f0-4033-b91a-19763901787e" />



#### DNS Flood 
﻿- For the time range Jun 11, 2021 @ 18:28:00.000 to Jun 11, 2021 @ 18:30:00.000, the NetFlow data showed that a DNS flood occurred. 
- This attack was identified by three examples in the data. 
  - First, nearly all traffic in the NetFlow data was UDP rather than TCP.
    - This is a key indicator in a DNS flood, as UDP is connectionless and easier to spoof than TCP.
  - Second, and most obvious, is the high count for DNS traffic in the data.
    - This shows that the attacker was rapidly sending DNS requests through the network.
  - Third, there were dozens of source IP addresses and only one destination IP address. This indicates that the attacker spoofed IP addresses and then sent DNS queries to the single server. 

- To mitigate a DNS flood, well-known techniques may be employed.
- The first mitigation is to **disallow unsolicited DNS responses**.
  - In a legitimate DNS query, a resolver makes a request to a server, and the server sends a response to the resolver.
  - In the case of a DNS flood, the attacker sends responses to a resolver without any requests in the first place.
  - By blocking unsolicited responses, this attack can be reduced. Second, dropping rapid retransmissions from the same IP address prevents single spoofed IP addresses from making a large impact.
  - Following this, **enabling a timeout on responses to individual queries** prevents the resolver from becoming overloaded with responding to every malicious request. 
<img width="705" height="350" alt="image" src="https://github.com/user-attachments/assets/c4b09fea-7a04-4d41-8514-d6f245fd8463" />



















  
