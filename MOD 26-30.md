- `ICMP && data.Len > 70`
- `dns.quy.name.Len > 60`
- `smtp.from` `smtp.subject`


# MOD 27 
## Protocol Tunneling
### Protocol Encapsulation and Tunneling
- Tunneling is a network technique that masks the purpose of data, making it a useful technique for legitimate and malicious activities.
- Tunneling relies on protocol encapsulation.  

#### Protocol Encapsulation
- Protocol encapsulation is the process of wrapping data in the format of another protocol to ensure compatibility and efficient transmission across networks
- Tunneling uses protocol encapsulation to obscure data as it travels between two points.
- Although there are other uses of protocol encapsulation that are not tunneling, the primary use is tunneling, so they are often referred to interchangeably.
- This layered approach ensures that the inner protocol operates as expected, even across a network in which the protocol is not supported.

#### Tunneling
﻿- The primary goal of tunneling is to place a variety of traffic into a standardized package to ensure that all of the traffic ends up at the right place while also obscuring what is in the package from an outside view.
- This enables a variety of different services, such as Domain Name System (DNS) and Server Message Block (SMB) protocol, to function as if there is no separation between the networks.
- Tunneling bridges the gap between disparate network entities, often connecting private networks over the public internet.
- This is not only about connectivity; it is about creating secure, reliable pathways on an otherwise open and vulnerable internet.
- Consider the significance of tunneling in scenarios where remote access or site-to-site connections enable remote work and collaboration.
- Through tunneling, remote users gain access to central networks, and geographically separated offices operate as if they are connected to the same single network

#### The Role of Encryption in Tunneling
﻿- Encryption is the process of encoding data so that it can only be accessed by authorized parties.
- When coupled with encryption, tunneling provides the assurance that the packaged traffic is obscured from unauthorized parties
- The extent to which the traffic is safe or encrypted varies between different tunneling protocols.
- Encryption makes tunneling protocols such as IPsec, Secure Socket Tunneling Protocol (SSTP), and OpenVPN useful for creating secure Virtual Private Networks (VPN).
- When data is tunneled through these encrypted channels, it becomes incredibly difficult for attackers to intercept, read, or manipulate the information.

### Non-Malicious Use Cases
#### IPsec
- IPsec is a suite of protocols that authenticates and encrypts the Internet Protocol (IP) packets of a communication session.
- IPsec operates in the following modes:
  - Transport mode: Encrypts the payload of the IP packet only, leaving the header unencrypted.
  - Tunnel mode: Encrypts the entire IP packet, including both the payload and the headers. 

#### GRE
- GRE is a tunneling protocol that encapsulates a wide variety of network layer protocols inside virtual point-to-point links
- It is widely used for VPNs and is known for its versatility and simplicity.
- GRE does not provide encryption or confidentiality; instead, it is often combined with IPsec for secure data transmission.
- The main advantage of GRE is that it encapsulates diverse protocols.
- However, this comes at the cost of lacking built-in security features.

### Layer 2 Tunneling Protocol
- Layer 2 Tunneling Protocol (L2TP) is used to support VPNs and does not provide encryption.
- Instead, it relies on an encryption protocol like IPsec for security.
- A unique feature of L2TP is its ability to tunnel traffic between different types of networks, making it very versatile for establishing connections.
- This is less important in modern networking since most modern networks use the same technology and speak the same languages.
- However, as a legacy protocol, L2TP is useful in older networks that need to communicate at a low level.

#### SSTP
- SSTP is a form of VPN tunnel that provides a mechanism to transport Point-to-Point Protocol (PPP) traffic through a Secure Sockets Layer (SSL) or Transport Layers Security (TLS) channel.
- SSL and TLS provide transport-level security with key negotiation, encryption, and traffic integrity checking.
- The use of SSL over Transmission Control Protocol (TCP) Port 443 allows SSTP to pass through common network infrastructure, such as firewalls and proxy servers.
- Unlike other protocols that can be blocked by restrictive firewalls, SSTP is more likely to be accessible since it largely operates like a (HTTPS) connection, which is often allowed through network security setups.

#### OpenVPN
- OpenVPN is an open-source tunneling protocol that can be used to create secure point-to-point or site-to-site connections.
- It uses SSL and TLS for key exchange and is capable of traversing Network Address Translators (NAT) and firewalls.
- OpenVPN allows peers to authenticate each other using pre-shared secret keys, certificates, or username and password credentials.
- When compared to other protocols like L2TP or IPsec, OpenVPN offers a more flexible solution.
- OpenVPN works on a wide range of port numbers and is compatible with various encryption algorithms.
- Users can use a variety of free software on almost any platform to connect to the VPN, often with only a pre-generated configuration file or a simple username and password.
- This makes OpenVPN much simpler to use for the end-user compared to other tunneling protocols.

### malicious Use Cases for Tunneling
#### DNS Tunneling
- DNS tunneling leverages the DNS protocol. In DNS tunneling, data is encoded into DNS queries and responses.
- This method is particularly insidious because DNS traffic is often allowed to pass through network firewalls without much scrutiny.
- Attackers exploit this by embedding data within DNS requests and receiving information through DNS responses.
- Exploiting DNS tunneling involves the client encoding the data into a DNS query and sending it to a compromised or attacker-controlled DNS server.
- The server then decodes the query, extracts the data, and can send back information through DNS response records
- Malicious DNS tunneling is difficult to detect because the malicious traffic closely mimics legitimate DNS traffic.
- It requires advanced detection techniques that can analyze DNS query patterns and frequencies to identify anomalies.

#### Internet Control Message Protocol Tunneling
- Internet Control Message Protocol (ICMP) tunneling is used for sending error messages and network operational information.
- ICMP Tunneling involves embedding data into ICMP packets. Since ICMP is a low-level network protocol primarily used for diagnostics and not for data transfer, its traffic is often overlooked.
- Many network security systems do not inspect ICMP packets as thoroughly as they do TCP or User Datagram Protocol (UDP) traffic.
- This oversight provides a window for attackers to exploit ICMP packets for covert communication.

#### Hypertext Transfer Protocol Tunneling
- Hypertext Transfer Protocol (HTTP) and HTTPS tunneling use the HTTP or HTTPS protocol to send data to an external server.
- This method is often used by attackers because HTTP and HTTPS traffic is highly common in network environments, making the tunneling activities blend in with normal traffic.
- Data is encapsulated within regular HTTP or HTTPS requests and sent to an external server.
- The prevalence of HTTP and HTTPS traffic in corporate environments makes it less likely for this exfiltration method to be flagged as suspicious.
- Additionally, the use of HTTPS encrypts the tunneled traffic, thereby concealing the exfiltrated data.

#### Secure Shell Tunneling
- Secure Shell (SSH) tunneling sends traffic over the SSH protocol and is often used for malicious activities because of its strong encryption, which makes the traffic difficult to detect and inspect.
- Attackers can set up an SSH tunnel to forward data securely from the target machine to an external server.
- SSH is also commonly used within other tunneling methods to perform commands and exfiltrate data due to its ease of use and inherent encryption.
- For example, an attacker could set up a DNS tunnel between their machine and a compromised machine.
- They could then SSH through that tunnel to encrypt the otherwise plaintext traffic within the tunnel.


## Detecting DNS Tunneling
### DNS Tunneling Detection
#### Techniques
﻿- Use the techniques described below when looking for DNS tunneling. These techniques are listed in the order of easiest to most difficult.

##### Filter for DNS traffic not over port 53
﻿- Filtering for DNS traffic not over port 53 takes advantage of the Zeek dns.log, which has the ability to identify DNS traffic over non-standard ports. 
- Because of the limitations of DNS, malicious actors occasionally use DNS over alternative protocols such as HTTP to facilitate more stable DNS tunneling.

##### Filter out DNS traffic to and from the network’s DNS server
﻿- When a malicious actor uses DNS tunneling they sometimes specify the DNS server so the traffic is not routed through the network’s DNS server. 
- Filtering out traffic to and from the DNS server leaves only DNS traffic behaving abnormally.

##### Look for large TXT records
﻿- Because TXT records are commonly used in DNS tunneling, looking for large TXT records can be an indication of DNS tunneling.
- Look for large amounts of DNS traffic over a short time frames
- Create a visualization of DNS records over time and identify times where a host made a relatively large number of DNS requests over a short period of time.
- This can be an indication of DNS tunneling and can identify domains and hosts that need to be investigated.

##### Analyze DNS requests and responses
﻿- Analyze DNS records, especially for unique domains. When using this technique, focus on subdomains and the DNS TXT field.

## Detecting Pass-the-Hash
### Detecting Pass-the-Hash
- Detection of PtH attacks using a log aggregation tool like the Elastic Stack involves analyzing relevant logs and events to identify abnormal patterns or suspicious activities.
- This can be particularly challenging because it leverages legitimate authentication methods.
- However, correlation of different logs, including logon events, network connections, and special logon events with suspicious host-based activity, may lead to the discovery of these types of attacks.

- Regarding network-based logs, Zeek captures NTLM activity occurring between hosts and saves it in a dataset labeled ntlm.
- This log contains extremely useful data, including source and destination (IP) addresses, the username associated with the authentication, and whether or not the authentication was successful.
- Searching for these events can provide a time frame and a set of suspicious logons, but alone they cannot provide enough context to definitively say that a specific event is an attacker performing PtH. 
- Some Windows logs are also extremely relevant to detecting PtH. The following is a list of each event Identifier (ID) and how it relates to PtH.

#### Windows Event ID 4624
##### Definition
﻿- This Windows Security log represents a successful logon event; the event is generated when a user successfully logs on to a computer. 
 The information provided in this event includes such details as the account name, account domain, logon type, source IP address, and the time of the logon.

##### PtH Relation
﻿- Each usage of PtH has a matching logon event. Additionally, the most common type of logon when using PtH is type 3, or network logon. 
 To filter out false positives, look for such patterns as multiple successful logons from different locations in a short time frame, especially if these logons are associated with the same user account. 
 Anomalies in logon types, such as interactive logons from unexpected sources, may also raise flags.

#### Windows Event ID 4672
##### Definition
﻿- This Windows Security log is related to special logon events. 
 This event is generated when a special privilege is assigned to a new logon session. 
 Special privileges include such actions as impersonating a client after authentication, creating a token object, and assigning primary privileges.

##### PtH Relation
﻿- PtH may be done only with privileged accounts, and when these accounts log on, they generate Windows event ID 4672. 
- The SYSTEM account, in particular, always generates this event. 
- This event also provides a specific list of the privileges assigned to that logon, which can help analysts determine whether or not an account that normally does not have special privileges has gained additional privileges.
- The following are some key privileges that are usually associated with PtH:
  - SeSecurityPrivilege: Manage auditing and security log.
  - SeTakeOwnershipPrivilege: Take ownership of files or other objects
  - SeDebugPrivilege: Take ownership of files or other objects.
  - SeSystemEnvironmentPrivilege: Modify firmware environment values.
  - SeImpersonatePrivilege: Impersonate a client after authentication.

- In a network with Sysmon configured, the following additional events are generated by PtH.

#### Sysmon ID 1
##### Definition
﻿- This event is triggered when a new process is created on the system. 
- It logs the Process ID (PID), Parent Process ID (PPID), command line, and other details about the created process.
##### PtH Relation
﻿- The attacker must use some process to perform the PtH attack. 
- Finding this process allows the analyst to work both forward and backward to find other malicious activity.
- This event may also be used to find malicious executables that perform the actions leading up to the PtH attack, such as retrieving the hashes from memory.

#### Sysmon ID 3
﻿##### Definition
﻿- This event logs information about network connections established by processes. 
- It includes such details as the process creating the connection, source and destination IP addresses, and ports.

##### PtH Relation
﻿- These events go hand in hand with the NTLM capture from the Zeek logs. 
- Cross-referencing each NTLM event with the process that initiated the connection can lead to determination of whether that process is potentially malicious.

## KERBEROS
### Detecting Kerberos Attacks
- Detecting attacks on Kerberos can be difficult because many of the steps may appear to be normal network activity.
- Additionally, many Kerberos-specific Windows event logs are not enabled by default, which may lead to a lack of evidence to detect these attacks.
- Because of these factors, detecting Kerberos attacks is based on not only searching for specific events but also looking for a suspicious frequency and source and correlating these with other malicious activity.
- The following are Kerberos-specific Windows events that are helpful in detecting malicious activity.

#### Event ID 4768
- A Kerberos Authentication Ticket Was Requested

#### Event ID 4768 
- indicates that a user or service attempted to request a TGT from the KDC during the authentication process.
- A common scenario is when a user logs in or when a service initiates authentication.

#### Event ID 4769 - A Kerberos Service Ticket Was Requested
﻿
#### Event ID 4769 occurs when a user or service requests an ST from the KDC. 
- The ST is used to access a specific service within the domain. 

#### Event ID 4770 - A Kerberos Service Ticket Was Renewed
﻿
#### Event ID 4770 indicates that a Kerberos ST was renewed by the KDC. 
- Ticket renewal is part of the Kerberos protocol to extend the validity period of an ST without requiring the user to reauthenticate.

#### Event ID 4771 - User Principal Exists But an Invalid Password Was Provided
﻿
#### Event ID 4771 occurs when a user attempts to authenticate with a valid user principal (username) but provides an incorrect or invalid password. 
- A common scenario is when a user fails to log in due to entering the wrong password, possibly as a result of a typographical error, forgotten password, or malicious login attempt.

<img width="1225" height="666" alt="image" src="https://github.com/user-attachments/assets/f1f16bbe-25d7-4916-80ef-d0e575cf5790" />











