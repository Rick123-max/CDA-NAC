# MOD 21
## Simple Visualizations
<img width="639" height="313" alt="image" src="https://github.com/user-attachments/assets/39b96c84-2039-4246-b219-cf6ac4bbfc2e" />




# MOD 22
## Deep Packet Inspection Challenges
### Suricata Module Configuration
- While the default settings of Zeek DPI modules are typically suitable for most environments Suricata may require additional configuration to maximize performance and accuracy of the resulting inspection.

#### Suricata’s Flow Module
- Flow control in Suricata is not typically classified as a standalone "module" like the protocols and services listed (e.g., HTTP, FTP, SMTP).
- Instead, flow control is a fundamental part of Suricata's Flow Manager or Flow Engine, which manages and tracks network connections or “flows," and helps ensure the efficient handling and analysis of traffic passing through the Intrusion Detection System and Prevention System (IDPS).

#### Flow Control in Suricata
- Optimizing the Flow Manager module allows Suricata's IDPS to effectively monitor a large number of concurrent connections without exhausting system resources.
- This optimization requires managing the following features:
  - Flow
  - Memory
  - Performance

#### Flow
- Flow management refers to how Suricata tracks and manages network flows, or "sessions."
- This involves the stateful tracking of connections for (**TCP**), (**UDP**), and other protocols to ensure these connections are monitored correctly over their lifecycles.
- Suricata can be configured to manage how long TCP, UDP, and other protocol flows are retained in memory by using the parameters new, established, and closed, as defined below:
  - new. A connection that has just been initiated and is in the early stages of its lifecycle. In a TCP connection, the flow is considered new during the SYN and SYN-ACK exchange before the connection is fully established.
  - established. A connection that has been fully set up and is actively transmitting data. For TCP, this means the connection has completed the three-way handshake and is now in a data exchange phase. Since UDP is connectionless, a flow is considered established as soon as it is detected.
  - closed. (TCP only) A connection that has been terminated. For TCP, this occurs after the FIN and FIN-ACK packets have been exchanged, completing the connection termination. This state is useful for capturing any late-arriving packets and for further analysis.

- In the example below, setting shorter timeouts for UDP flows–which are connectionless and stateless–can help prevent unnecessary memory resource consumption:

```
flow-timeouts:

  tcp:

    new: 60

    established: 3600

    closed: 120

  udp:

    new: 30

    established: 200  # Reduced timeout for UDP to avoid memory bloat
```


#### Memory
- Memory management in Suricata involves configuring the system to handle a large number of concurrent connections without exhausting available memory.
- This is done by setting parameters such as memcap, hash_size, and prealloc, which dictate how much memory is allocated for flow tracking.
- The following are key memory parameters that impact performance:
  - memcap. Limits the memory allocated for flow tracking.
  - hash_size. Determines the size of the hash table used for flow tracking, which affects the efficiency of flow lookups.
  - prealloc. Defines the number of flow records that are pre-allocated in memory, which can improve performance by reducing dynamic memory allocation during high traffic periods.
  - prune_flows. Specifies the percentage of flows to remove when in emergency recovery mode.

- In the example below, increasing memcap allows Suricata to track more flows without running out of memory, while a larger hash_size reduces hash collisions, which improves lookup speed.
- Preallocating flows reduces the overhead of dynamic memory allocation during traffic spikes.

```
flow:

  memcap: 67108864   # 64 MB for flow tracking

  hash-size: 131072  # 128K entries in the hash table

  prealloc: 20000    # Pre-allocate 20,000 flow entries
```

#### Performance
- Performance tuning in Suricata is about optimizing the system's configuration to handle high traffic volumes efficiently.
- This involves tweaking flow control settings, such as TCP and UDP flows, to ensure Suricata can process incoming traffic without dropping packets or slowing down.
- In addition to normal flow settings, emergency states are used when the system is under memory pressure and must quickly reduce the time flows that are kept in memory to prevent overload.
  - emergency_recovery. The threshold at which Suricata begins to prune flows to prevent memory exhaustion.
  - emergency_new. The duration for which Suricata retains a newly detected flow in memory when the system is under stress or low on resources.
  - emergency_established. The duration for which Suricata keeps established flows in memory under emergency conditions.
  - emergency_closed. The duration for which Suricata retains flows that have been closed (specifically for TCP connections) when the system is experiencing resource constraints

- In the example below, during high traffic periods, emergency timeouts can be reduced to quickly remove inactive flows and free up resources.

```
flow-timeouts:

  emergency_new: 10

  emergency_established: 100

  emergency_closed: 20
```


#### Maximum Transmission
- The maximum transmission can be set using the field max-tx in the FTP, MQTT, PostgreSQL, SMB, Distributed Computing Environment / Remote Procedure Calls (DCERPC), and Network File System (NFS) modules.
- The HTTP2 module field is as follows:
  - `max-transfer.`


#### HTTP Options
- The HTTP DPI module in Suricata is libhtp and can be configured in the `suricata.yml` file.

##### Personalities
- Personalities are tuned to different types of web servers.
- The following list shows the available personalities in the libhtp DPI module.
  - Minimal
  - Generic
  - Intrusion Detection System (IDS) (default)
  - Microsoft Internet Information Services/Server (IIS) versions:
    - IIS_4_0
    - IIS_5_0
    - IIS_5_1
    - IIS_6_0
    - IIS_7_0
    - IIS_7_5
  - Apache
  - Apache_2_2

##### Request/Response Limit
- As HTTP response and request bodies are variable length, they can overwhelm Suricata.
- The request and response limit sets the maximum size of the request or response body the module examines.
- The fields to set the limit is request-body-limit and response-body-limit. Setting the limit to 0 inspects the entire body.

##### Addresses
- The addresses field sets the address of a server.
- This field is useful in environments where multiple web servers of different personalities are present.

##### Example Configuration
- The following is an example configuration of the libhtp module in `suricata.yml`.
- This example uses the IIS_7_0 personality to examine traffic to and from the web server located at 192.168.2.7 and the IDS personality for all other web traffic.
- The line `- iis7` is a label to improve the readability of the configuration file and is useful when configuring multiple server personalities.

```
libhtp:
	default-config: 
		personality: IDS
		request-body-limit: 3027
		response-body-limit: 3027
	server-config:
		- iis7
			address: 192.168.2.7
			personality: IIS_7_0
			request-body-limit: 0
			response-body-limit: 0
```

#### SMB Options
- The SMB DPI module uses the name smb and can be configured in the `suricata.yml` file.

##### Enabling the SMB module
- The SMB DPI module is disabled by default and can be enabled using the enabled field.

##### Size and Count-Based Events
- The maximum size and count fields can be used to set the maximum read and write size of an SMB connection which generates an event if the size or count exceeds the setting.
- The fields for this setting are as follows:
  - max-read-size
  - max-write-size
  - max-read-queue-size
  - max-read-queue-cnt
  - max-write-queue-size
  - max-write-queue-cnt
- If the field is set to 0 it does not create an event.

##### Example Configuration
- The following is an example configuration of the SMB module in suricata.yml.
- This example sets the maximum read size to 8 Megabytes (MB), the maximum write size to 1 MB, the maximum queue sizes to 16 MB, and the maximum queue counts to 16.

```
smb:
  enabled: yes
  max-read-size: 8mb
  max-write-size: 1mb

  max-read-queue-size: 16mb
  max-read-queue-cnt: 16

  max-write-queue-size: 16mb
  max-write-queue-cnt: 16
```

#### SSL/TLS Options
- The SSL/TLS DPI module tracks encrypted sessions for SSL versions 2 and 3 as well as TLS versions 1.1 and 1.2.

##### Detection Ports
- By default the SSL/TLS module only inspects SSL/TLS sessions over TCP port 443. This setting is modified using the detection-ports and dp fields.

##### Encryption Handling
- The encryption handling setting, using a field name encryption-handling, defines how the SSL/TLS DPI module handles encrypted traffic once the session has been established.
- The field has the following options:
  - default: the session continues to be tracked but raw content inspection is disabled.
  - bypass: the session content is not processed after the session is established.
  - full: the session is processed as normal without bypass or inspection limits.

- In environments with substantial traffic, the bypass option provides the best performance.

##### Example Configuration
- The following is an example configuration of the TLS module in suricata.yml.
- This example sets the detection ports to TCP 443 and uses the bypass option.

```
tls: 
	enabled: yes
	detection-ports: 
		dp: 443
	encryption-handling: bypass
```

### Configure DPI
#### Configuring DPI
- An OPORD has been issued for a mission on SimSpace Power Plant.
- Using the information in the OPORD, identify configuration changes to optimize DPI performance.

#### W﻿orkflow
﻿1. Open the attached OPORD document and review the situation paragraph. Under the Enemy Forces heading, identify the enemy and their likely target. The Friendly Forces heading also contains important information about the critical infrastructure.
2. In the OPORD, examine the mission paragraph and identify the assigned mission.
3. Review the commander’s intent in the execution paragraph to identify the intent of the assigned mission.
  - After reviewing the situation, mission, and commander’s intent, the following information was identified:
    - The enemy is known to target public-facing web servers for initial access.
    - The mission involves monitoring the public-facing web server.
    - The web server is running Apache version 2.2.
    - Expected requests are less than 10 MB in length.
    - Expected responses are less than 16 MB in length.
  - After reviewing the OPORD, it is determined the CPT installed a Suricata agent on the edge-firewall of the network, but it is not fully configured.
  - The network diagram (attached) illustrates that the Suricata sensor does have visibility of traffic to the Apache Web Server in the DMZ. 
4. Open and view the attached Network Diagram.
  - Modify the configuration located on the lin-hunt-cent Virtual Machine (VM) to optimize the DPI engine by completing the following steps.
5. Open the terminal and run the following command to open the suricata.yml file in the Sublime Text editor:
    - `sudo subl /etc/suricata/suricata.yaml`
﻿6. Scroll to the libhtp section of the configuration file located at line 870.
  - The current configuration uses the IDS personality and has no server personalities configured.
  - Modify the configuration to include an optimal personality using the information in the OPORD and the network map by completing the following steps.

7. On line 931, under the server-config: heading, add a configuration for the mission partner’s Apache web server using the following settings:

```
- apache
	address: 172.16.8.5
	personality: Apache_2_2
﻿```

9. Set the request-body-limit to 10MB and the response-body-limit to 16MB based on information from the OPORD. Enter the following to the configuration:
  - `request-body-limit: 10mb`
  - `response-body-limit: 16mb`






